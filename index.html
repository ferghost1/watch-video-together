<html>
  <head>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.27.4.js"></script>
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"
    ></script>
  </head>
  <style>
    .container {
      margin-bottom: 20px;
    }
  </style>

  <body>
    <div id="host-inputs" class="container">
      <div>Pub key <input type="text" id="pubKey" width="500" /></div>
      <div>Sub key <input type="text" id="subKey" width="500" /></div>
      <div>Uuid <input type="text" id="uuid" width="500" /></div>
      <div>Channel name <input type="text" id="channel" width="500" /></div>
      <div>
        Link film <input type="text" id="link-video" style="width: 500px" />
      </div>
      <div>
        <label for="addtional-time">Additional time with host</label>
        <input id="addtional-time" value="0" step="0.5" type="number" />
        <button id="test-delay" onclick="testDelay()">Test Delay</button>
      </div>
      <div id="diff-time-container" class="container">
        <label for="diff-time">Diff time</label>
        <input id="diff-time" value="1000" type="number" />
        <button id="set-diff-time" onclick="emitSetDiffTime()">
          Set Diff Time
        </button>
      </div>
      <div>
        Host url:
        <input type="text" id="host-url" style="width: 500px" />
        <button id="set-host-url" onclick="emitHostUrl()">Set Host URL</button>
      </div>

      <div id="url-container"></div>

      <br />

      <button id="create-channel-button" onclick="makeChannel()" type="button">
        Create Channel
      </button>

      <button id="create-video" onclick="handleCreateVideo()" type="button">
        Create Video
      </button>

      <button id="sync-video" onclick="handleSyncVideo()" type="button">
        Sync Video
      </button>

      <button
        id="sync-timestamp"
        onclick="emitSyncServerTimestamp()"
        type="button"
      >
        Sync timestamp
      </button>
    </div>

    <div id="subscriber-inputs" class="container">
      <button
        id="subscribe-button"
        onclick="handleSubscribeClick()"
        type="button"
      >
        Subscribe
      </button>
      <div id="subscribed-info"></div>
      <br />
      <div>
        <span>Test Delay:</span>
        <span id="delay-value"></span>
      </div>
    </div>

    <div id="standart-time-container" class="container">
      <button onclick="createStandardDate()">Fetch Standard Date</button>
      <div>
        <span>Milisecond Greater Than Server:</span>
        <span id="time-greater-than-server"></span>
      </div>

      <div>
        <span>Request time:</span>
        <span id="request-time"></span>
      </div>

      <div>
        <span>Standard time:</span>
        <span id="standard-time"></span>
      </div>
    </div>

    <div id="test" class="container"></div>
    <div id="action" class="container"></div>

    <div id="video-container" class="container">
      <video
        id="video"
        type="video/mp4"
        playsinline
        width="900"
        height="450"
        controls
      ></video>
    </div>

    <script type="text/javascript">
      let serverTimestamp = Date.now();

      class WsConnection {
        wsUrl = "wss://wbxpc2b1-8889.asse.devtunnels.ms";
        wsAction = {
          SYNC_SERVER_TIMESTAMP: "SYNC_SERVER_TIMESTAMP",
          HEART_BEAT: "HEART_BEAT",
        };
        wsConn;
        retryTime = 0;
        intervalPing = 0;

        constructor() {
          this.init();
        }

        async init() {
          document.getElementById("action").innerText = `Connecting to ws.`;
          this.connect();
        }

        async connect() {
          this.wsConn = new WebSocket("wss://wbxpc2b1-8889.asse.devtunnels.ms");

          // retry until success
          this.wsConn.onerror = (event) => {
            if (event.target.readyState === WebSocket.CLOSED) {
              document.getElementById("action").innerText = `Connect closed!`;

              this.connect();
            }
          };

          this.wsConn.onclose = (e) => {
            console.log(`e.code, e.reason`, e.code, e.reason);
            console.log(`e`, e);
          };

          this.wsConn.onopen = (msg) => {
            console.log(`open`, msg);
            document.getElementById("action").innerText = `
              Connect success!
              `;

            this.handleAddEvent();
          };
        }

        handleAddEvent() {
          this.wsConn.onmessage = (msg) => {
            console.log(`msg`, msg);
            const { action, data } = JSON.parse(msg.data);
            console.log(`action, data`, action, data);
            switch (action) {
              case this.wsAction.SYNC_SERVER_TIMESTAMP:
                serverTimestamp = data.serverTimestamp;
                createStandardDate();

                document.getElementById("test").innerText = `
              greater than sv: ${Date.now() - serverTimestamp}
            `;
                break;

              default:
                break;
            }
          };
        }

        syncServerTimestamp() {
          if (this.wsConn.readyState !== WebSocket.OPEN) {
            console.log(`Ws wasn't connected.`);
          }

          this.wsConn.send(
            JSON.stringify({ type: this.wsAction.SYNC_SERVER_TIMESTAMP })
          );
        }
      }
      const wsClient = new WsConnection();

      class StandardDate {
        serverTimestamp;
        localGreaterThanStandardInMs;
        isUseLocal;

        constructor({ serverTimestamp, isUseLocal }) {
          this.serverTimestamp = serverTimestamp;
          this.isUseLocal = isUseLocal;

          this.init();
        }

        async init() {
          if (this.isUseLocal) {
            console.log(`use local timestamp as standard`);
            this.localGreaterThanStandardInMs = 0;
            return;
          }

          this.syncTime();
        }

        //  Get server time at any specific time on local
        getCurrentTime() {
          // return this.standardTimestamp + Date.now() - this.createdAt;
          return Date.now() - this.localGreaterThanStandardInMs;
        }

        async syncTime() {
          this.localGreaterThanStandardInMs = Date.now() - this.serverTimestamp;

          document.getElementById("time-greater-than-server").innerText =
            this.localGreaterThanStandardInMs;
        }
      }

      const eventType = {
        MAKE_CHANNEL: "MAKE_CHANNEL",
        SYNC_VIDEO: "SYNC_VIDEO",
        PLAY: "PLAY",
        PAUSE: "PAUSE",
        SEEK: "SEEK",
        TEST_DELAY: "TEST_DELAY",
        SET_DIFF_TIME: "SET_DIFF_TIME",
        SET_HOST_URL: "SET_HOST_URL",
        SYNC_HOST_TIMESTAMP: "SYNC_HOST_TIMESTAMP",
      };

      const hostEndpoint = {
        GET_TIMESTAMP: "timestamp",
        GET_GREATER_TIMESTAMP: "timestamp/greater-than-server",
      };

      var pubnub;
      var interval;

      let channel;
      let linkVideo;
      let pubKey;
      let subKey;
      let uuid;
      let standardDate;
      let standardDateInterval;
      let diffTime;
      let hostUrl;

      const queryStr = new URLSearchParams(window.location.search);
      const isHost = !!queryStr.get("host");

      let subscribed = false;
      const hls = Hls.isSupported()
        ? new Hls({
            maxMaxBufferLength: 90, // Allow 1.5 minutes of buffer
            maxBufferLength: 90, // Set buffer retention to 1.5 minutes
            startFragPrefetch: true,
            fragLoadingMaxRetry: 10,
            fragLoadingRetryDelay: 700,
          })
        : null;

      init();

      function createStandardDate() {
        standardDate = new StandardDate({
          serverTimestamp,
          isUseLocal: isHost,
        });
      }

      function init() {
        hostUrl = localStorage.getItem("hostUrl");
        createStandardDate();

        if (isHost) {
          document.getElementById("pubKey").value =
            localStorage.getItem("pubKey");
          document.getElementById("subKey").value =
            localStorage.getItem("subKey");
          document.getElementById("uuid").value =
            localStorage.getItem("uuid") || Math.random().toString(36);
          document.getElementById("channel").value =
            localStorage.getItem("channel") || Math.random().toString(36);
          document.getElementById("link-video").value =
            localStorage.getItem("linkVideo") ||
            "http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4";
          document.getElementById("diff-time").value =
            localStorage.getItem("diffTime") || 1000;
          document.getElementById("host-url").value = hostUrl;

          document.getElementById("subscriber-inputs").remove();
        } else {
          // for client
          document.getElementById("host-inputs").remove();
        }
      }

      function connectServer(data) {
        pubnub = new PubNub({
          publishKey: data.pubKey,
          subscribeKey: data.subKey,
          uuid: data.uuid,
        });
      }

      function makeChannel() {
        channel = document.getElementById("channel").value;
        pubKey = document.getElementById("pubKey").value;
        subKey = document.getElementById("subKey").value;
        uuid = document.getElementById("uuid").value;

        localStorage.setItem("pubKey", pubKey);
        localStorage.setItem("subKey", subKey);
        localStorage.setItem("uuid", uuid);
        localStorage.setItem("channel", channel);

        const pubnubConfig = { pubKey, subKey, uuid };
        connectServer(pubnubConfig);

        const host = location.href.replace(location.search, "");
        const link = `${host}?pubKey=${pubKey}&subKey=${subKey}&uuid=${uuid}&channel=${channel}`;
        document.getElementById("url-container").innerText = link;
      }

      function handleCreateVideo() {
        if (!pubnub) {
          console.log(`missing pubnub`);
          return;
        }

        const inputSrc = document.getElementById("link-video").value;
        localStorage.setItem("linkVideo", inputSrc);

        let src = inputSrc;
        const inputSrcOrigin = new URL(inputSrc).origin;
        if (
          inputSrcOrigin.includes(`qnguyen-dev.work`) ||
          inputSrcOrigin.includes(`devtunnels.ms`)
        ) {
          src = inputSrc.replace(inputSrcOrigin, "http://localhost:8889");
        }

        makeVideoTag(src);
        addHostEvent();
      }

      function handleSyncVideo() {
        const videoSrc = document.getElementById("link-video").value;
        emitSetDiffTime();
        emitSyncServerTimestamp();

        pubnub.publish({
          channel: channel,
          message: {
            type: eventType.SYNC_VIDEO,
            src: videoSrc,
          },
        });
      }

      function handleSubscribeClick() {
        if (!pubnub) {
          connectServer({
            pubKey: queryStr.get("pubKey"),
            subKey: queryStr.get("subKey"),
            uuid: queryStr.get("uuid"),
          });
        }

        pubnub.unsubscribeAll();
        pubnub.subscribe({
          channels: [queryStr.get("channel")],
        });
        document.getElementById(`subscribed-info`).innerText = `subscribed`;

        // listener pubnub event
        if (subscribed) {
          return;
        }

        pubnub.addListener({
          message: function (msg) {
            let video = document.getElementById("video");
            let hostPlayingTime = msg.message.playingTime; // in second
            const hostStandardTimestamp = msg.message.standardTimestamp;
            const hostLocalTimestamp = msg.message.localTimestamp;
            const diffTimeStampWithHostInMs = diffTime ?? 0;
            // const adjustFollowHostTimestamp = Date.now() + diffTime; // This diffTime = 0 mean disabled
            // const transferedTime =
            //   (adjustFollowHostTimestamp - hostLocalTimestamp) / 1000;
            // const shouldPlayingTime = hostPlayingTime + addtionalInSecond;

            const transferedTime =
              (standardDate.getCurrentTime() +
                diffTimeStampWithHostInMs -
                hostStandardTimestamp) /
              1000;

            const shouldPlayingTime = hostPlayingTime + (transferedTime || 0);

            switch (msg.message.type) {
              case eventType.TEST_DELAY:
                const delayTime = hostStandardTimestamp - Date.now();
                document.getElementById("delay-value").innerText =
                  delayTime / 1000;
                break;

              case eventType.SYNC_VIDEO:
                makeVideoTag(msg.message.src);
                break;

              case eventType.PLAY:
                if (!video) {
                  console.log(`Missing video tag`);
                  break;
                }

                video.currentTime = shouldPlayingTime;
                video.play().then((res) => console.log(`res`, res));
                break;

              case eventType.SEEK:
                if (!video) {
                  console.log(`Missing video tag`);
                  break;
                }

                video.currentTime = video.paused
                  ? hostPlayingTime
                  : shouldPlayingTime;
                break;

              case eventType.PAUSE:
                if (!video) {
                  console.log(`Missing video tag`);
                  break;
                }

                video.currentTime = hostPlayingTime;
                video.pause();
                break;

              case eventType.SET_DIFF_TIME:
                diffTime = msg.message.diffTime ?? 0;
                break;

              // case eventType.SET_HOST_URL:
              //   hostUrl = msg.message.hostUrl;
              //   console.log(`hostUrl`, hostUrl);
              //   localStorage.setItem("hostUrl", hostUrl);
              //   createStandardDate();

              //   document.getElementById(
              //     "test"
              //   ).innerText = `host url: ${hostUrl}`;
              //   break;

              case eventType.SYNC_HOST_TIMESTAMP:
                const hostTimestamp = msg.message.hostTimestamp;
                document.getElementById("test").innerText = `
                        host time: ${hostTimestamp}
                        local time: ${Date.now()}
                        greater host: ${Date.now() - hostTimestamp}
                      `;

                break;
            }
          },
        });
        subscribed = true;
      }

      function testDelay() {
        pubnub.publish({
          channel,
          message: {
            type: eventType.TEST_DELAY,
            timestamp: Date.now(),
          },
        });
      }

      function emitSetDiffTime() {
        const diffTime =
          Number(document.getElementById("diff-time").value) || 0;
        localStorage.setItem("diffTime", diffTime);

        pubnub.publish({
          channel,
          message: {
            type: eventType.SET_DIFF_TIME,
            diffTime,
          },
        });
      }

      function emitHostUrl() {
        hostUrl = document.getElementById("host-url").value;
        localStorage.setItem("hostUrl", hostUrl);

        if (pubnub) {
          pubnub.publish({
            channel,
            message: {
              type: eventType.SET_HOST_URL,
              hostUrl,
            },
          });
        }
      }

      function emitSyncServerTimestamp() {
        wsClient.syncServerTimestamp();
      }

      function addHostEvent() {
        // add event for video
        let video = document.getElementById("video");
        if (!video) {
          console.log("missing video tag");
        }

        video.onplay = function () {
          const playingTime =
            video.currentTime +
            Number(document.getElementById("addtional-time").value || 0);

          pubnub.publish({
            channel,
            message: {
              type: eventType.PLAY,
              playingTime,
              localTimestamp: Date.now(),
              standardTimestamp: standardDate.getCurrentTime(),
            },
          });
        };

        video.onpause = function () {
          // in second decimal format: 22.54361
          const playingTime =
            video.currentTime +
            Number(document.getElementById("addtional-time").value || 0);

          pubnub.publish({
            channel: channel,
            message: {
              type: eventType.PAUSE,
              playingTime,
              localTimestamp: Date.now(),
              timestamp: standardDate.getCurrentTime(),
            },
          });
        };

        video.onseeking = function () {
          const playingTime =
            video.currentTime +
            Number(document.getElementById("addtional-time").value || 0);

          pubnub.publish({
            channel: channel,
            message: {
              type: eventType.SEEK,
              playingTime,
              localTimestamp: Date.now(),
              timestamp: standardDate.getCurrentTime(),
            },
          });
        };
      }

      function makeVideoTag(src) {
        const vidContainer = document.getElementById("video-container");
        vidContainer.innerText = "";

        const video = document.createElement("video");
        video.setAttribute("id", "video");
        video.setAttribute("controls", true);
        video.setAttribute("width", 600);
        video.setAttribute("height", 300);
        video.setAttribute("playsinline", true);
        video.setAttribute("preload", "auto");
        video.setAttribute("crossorigin", "anonymous");
        // video.muted = true;

        vidContainer.appendChild(video);

        if (src.endsWith("m3u8") && hls) {
          hls.detachMedia();
          hls.loadSource(src);
          hls.attachMedia(video);
        } else {
          const track = document.createElement("track");
          track.kind = "subtitles";
          track.label = "English";
          track.srclang = "en";
          track.src = `${src}.vtt`;
          track.default = true;
          video.appendChild(track);

          const source = document.createElement("source");
          source.src = src; // replace with your actual video file URL
          source.type = "video/mp4";
          video.appendChild(source);
          video.load();
        }
      }
    </script>
  </body>
</html>
